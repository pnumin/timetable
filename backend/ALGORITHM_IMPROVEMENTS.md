# 시간표 생성 알고리즘 개선 사항

## 개요
이 문서는 Task 20에서 구현된 시간표 생성 알고리즘의 개선 사항을 설명합니다.

## 구현된 기능

### 1. 연강 제한 기능 (Task 20.1)

#### 목적
동일 교관의 동일 과목이 3시간 이상 연속으로 배정되는 것을 방지합니다.

#### 구현 내용

**ScheduleRepository.ts**
- `getConsecutiveHoursForInstructorCourse()` 메서드 추가
  - 특정 날짜에 동일 교관의 동일 과목이 연속으로 몇 시간 배정되어 있는지 확인
  - 시작 교시 이전의 연속 시수를 계산

**ConstraintValidator.ts**
- `getConsecutiveHoursForInstructorCourse()` 메서드 추가
  - ScheduleRepository의 메서드를 호출하여 연속 시수 확인

**CourseAssigner.ts**
- `findNextAvailableSlot()` 메서드 업데이트
  - 슬롯을 찾은 후 연강 제한 체크 추가
  - 이미 3시간 이상 연속 배정된 경우 다음 날로 이동
  - 새로 배정할 시수와 기존 연속 시수를 합쳐서 3시간을 초과하지 않도록 조정

#### 동작 방식
```
1. 사용 가능한 시간대 찾기
2. 해당 시간대의 시작 교시 이전에 연속으로 배정된 시수 확인
3. 연속 시수가 3시간 이상이면 다음 날로 이동
4. 연속 시수 + 새 배정 시수가 3시간을 초과하면 배정 시수 조정
5. 조정된 시수로 배정
```

### 2. 평가 자동 배정 기능 (Task 20.2)

#### 목적
평가=1인 교과목이 완료된 후 다음날 자동으로 2시간 시험을 배정합니다.

#### 구현 내용

**데이터베이스 스키마 변경**
- `schedules` 테이블에 `is_exam` 컬럼 추가 (BOOLEAN DEFAULT 0)
- 시험 일정과 일반 일정을 구분

**models.ts**
- `Schedule` 인터페이스에 `is_exam: boolean` 필드 추가

**ScheduleRepository.ts**
- `create()` 메서드에 `is_exam` 파라미터 추가
- `findAllWithDetails()` 및 `findByDateRangeWithDetails()`에서 `is_exam` 필드 포함
- `update()` 메서드에 `is_exam` 업데이트 로직 추가

**CourseAssigner.ts**
- `assignCourse()` 메서드 업데이트
  - 마지막 배정 날짜와 교관 ID 추적
  - 평가=1인 경우 `scheduleExam()` 호출
- `scheduleExam()` 메서드 추가
  - 마지막 수업 다음날부터 2시간 시험 시간 찾기
  - 시험 시간을 찾을 수 없으면 경고 로그만 남기고 계속 진행
  - 시험 일정에 `isExam: true` 플래그 설정

**ScheduleGenerator.ts**
- 배정 정보 저장 시 `is_exam` 필드 처리

**schedule.ts (routes)**
- POST /api/schedules에서 `is_exam: false` 기본값 설정

#### 동작 방식
```
1. 교과목의 모든 일반 수업 배정 완료
2. 평가 필드가 '1'인지 확인
3. 마지막 수업 날짜의 다음날부터 2시간 시험 시간 찾기
4. 시험 시간 배정 (is_exam = true)
5. 시험 시간을 찾을 수 없으면 경고 로그만 남기고 계속 진행
```

### 3. ScheduleGenerator 서비스 업데이트 (Task 20.3)

#### 개선 사항

**로깅 개선**
- 각 교과목 배정 시작/완료 로그 추가
- 일반 일정과 시험 일정 개수 구분하여 로그 출력
- 배정 실패 시 상세 정보 포함 (과목 ID, 시수 등)
- 전체 생성 완료 시 성공/실패 통계 출력

**에러 처리 개선**
- 배정 실패 시 상세한 에러 메시지 생성
- 에러 목록을 번호와 함께 출력
- 일부 과목 배정 실패 시에도 나머지 과목 계속 처리

#### 로그 예시
```
교과목 배정 시작: 네트워크 보안 (시수: 6, 평가: 1)
교과목 배정 완료: 네트워크 보안 - 일반 일정 3개, 시험 일정 1개

시간표 생성 완료: 총 15개의 일정 생성
성공: 5개, 실패: 0개
```

## 마이그레이션

기존 데이터베이스에 `is_exam` 컬럼을 추가하려면:

```bash
npm run build
node dist/scripts/addIsExamColumn.js
```

## 테스트

알고리즘 개선 사항을 테스트하려면:

```bash
# 백엔드 서버 실행 (다른 터미널에서)
npm run dev

# 테스트 실행
node test-algorithm-improvements.js
```

테스트는 다음을 검증합니다:
1. 연강 제한: 동일 교관의 동일 과목이 하루에 3시간 이하로 배정되는지
2. 평가 자동 배정: 평가=1인 과목 완료 후 2시간 시험이 자동 배정되는지

## 요구사항 충족

- **Requirement 3.1**: 동일 교관의 동일 과목 3시간 이상 연강 방지 ✓
- **Requirement 3.2**: 평가=1인 교과목 완료 후 다음날 2시간 시험 자동 배정 ✓

## 주의사항

1. **시험 배정 실패**: 시험 시간을 찾을 수 없는 경우 경고 로그만 남기고 계속 진행합니다. 이는 시스템이 완전히 중단되는 것을 방지하기 위함입니다.

2. **연강 제한 우선순위**: 연강 제한은 하루 최대 3시간 제한보다 우선 적용됩니다. 즉, 이미 2시간 연속 배정된 경우 해당 날짜에는 최대 1시간만 추가 배정됩니다.

3. **데이터베이스 스키마 변경**: 기존 데이터베이스를 사용하는 경우 마이그레이션 스크립트를 실행해야 합니다.

## 향후 개선 가능 사항

1. 시험 배정 실패 시 사용자에게 알림
2. 시험 시간 배정 우선순위 설정 (예: 오전/오후 선호도)
3. 연강 제한 시간을 설정 가능하게 변경 (현재는 3시간 고정)
4. 교관별 연강 제한 설정 (교관마다 다른 제한 적용)
